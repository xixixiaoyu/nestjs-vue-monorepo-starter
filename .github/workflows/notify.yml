name: Notifications

on:
  workflow_run:
    workflows: ['CI', 'Security Scan', 'Deploy', 'Release', 'Performance Test']
    types:
      - completed

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.12.0'

jobs:
  # ç®€åŒ–çš„é€šçŸ¥ç³»ç»Ÿ - åªåœ¨å…³é”®å¤±è´¥æ—¶é€šçŸ¥
  critical-failures:
    name: Critical Failure Notifications
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Get workflow information
        id: info
        run: |
          echo "workflow=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT

      - name: Notify on critical failures
        run: |
          echo "ğŸš¨ Critical failure detected in ${{ steps.info.outputs.workflow }}!"
          echo "Branch: ${{ steps.info.outputs.branch }}"
          echo "Conclusion: ${{ steps.info.outputs.conclusion }}"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„é€šçŸ¥é€»è¾‘
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš¨ Critical failure in ${{ steps.info.outputs.workflow }}!\n\nBranch: ${{ steps.info.outputs.branch }}\n\nğŸ”— [View Workflow](${{ github.event.workflow_run.html_url }})"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # éƒ¨ç½²æˆåŠŸé€šçŸ¥
  deployment-success:
    name: Deployment Success Notifications
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'Deploy' && github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Notify on deployment success
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„é€šçŸ¥é€»è¾‘
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš€ Deployment completed successfully!\n\nBranch: ${{ github.event.workflow_run.head_branch }}\n\nğŸ”— [View Deployment](${{ github.event.workflow_run.html_url }})"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # å‘å¸ƒæˆåŠŸé€šçŸ¥
  release-success:
    name: Release Success Notifications
    runs-on: ubuntu-latest
    if: github.event.workflow_run.name == 'Release' && github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Notify on release success
        run: |
          echo "ğŸ‰ New release published!"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„é€šçŸ¥é€»è¾‘
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸ‰ New release is now available!\n\nBranch: ${{ github.event.workflow_run.head_branch }}\n\nğŸ”— [View Release](${{ github.event.workflow_run.html_url }})"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
